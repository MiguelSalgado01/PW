<!DOCTYPE html>
<html lang="en">
    <head>
        <title>LogIn</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
         <!--JQUERY-->
         <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.2/jquery.min.js" integrity="sha512-tWHlutFnuG0C6nQRlpvrEhE4QpkG1nn2MOUMWmUeRePl4e3Aki0VB6W1v3oLjFtd0hVOtRQ9PHpSfN6u6/QXkQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
         <!--BootStrap 5.2-->
         <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
         <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css">
        <link rel="stylesheet" href="style.css"> 
    </head>
    <body class="bg-secondary">
        <h1 class="py-4 text-white text-center fw-bold">LogIn</h1>
        <div class="position-absolute start-50 translate-middle" style="top: 25%; z-index: 1;">
            <div class="d-flex justify-content-center">
                <img
                        src="../Logo.png"
                        alt=""
                        class="border border-2 rounded-circle"
                        width="160px"
                        height="160px"
                />
            </div>
        </div>
        <div class="position-absolute start-50 w-100 translate-middle" style="top: 50%;">
            <div style="width: 90%;" class="container bg-light rounded-4 py-3 shadow-lg position-sticky">
                <div class="container w-100 col-6" style="margin-top: 30%;">
                    <div class="my-4">Nome Utilizador/Numero Estudante
                        <div class="input-group my-1 needs-validation" id="groupNameNumb">
                            <span class="input-group-text bg-secondary" id="basic-addon1">                    
                                <i class="fa fa-user text-white"></i>
                            </span>
                            <input type="text" class="form-control" id="username" placeholder="ex: Nikola Tesla" maxlength="50" required>
                            <div class="invalid-feedback"></div>
                        
                        </div>
                    </div>
                    <div class="my-4">Password
                        <div class="input-group my-1 needs-validation"  id="groupPass">
                            <span class="input-group-text bg-secondary" id="basic-addon1">                    
                                <i class="fa fa-key text-white"></i>
                            </span>
                            <input type="password" class="form-control" id="userPassword" maxlength="30"
                                placeholder="ex: Bobin@D3Te5L@" required> 
                            <div class="invalid-feedback">
                                Por Favor insira Password
                            </div>
                        
                        </div>
                        <a href="http://127.0.0.1:5500/FrontEnd/ForgotPass/ForgotPass.html">
                            <h6><dt> Esqueces-te a Password ?</dt></h6>
                        </a>
                    
                    </div>
                    <div class="container">
                        <div class="row">
                            <div class="col-1"></div>
                            <button class="btn btn-primary col-10 my-2" type="submit" id="LogBtn" onclick="clicarBotao()">LogIn</button> 
                            <div class="col-1"></div>
                            <div class="col-1"></div>
                            <button class="btn btn-outline-primary col-10 my-2" type="submit" id="RegistBtn" onclick="RegisterPage()">Registar</button> 
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
    </body>
    <script>
        var validationSpaces = document.getElementsByClassName("needs-validation"); 
        var userNameNumb = document.getElementById("username");
        var userPass = document.getElementById("userPassword");
        var rePassVal = 0, user = new Array();

        function clicarBotao(){
            console.log(userPass.value)
            var numFaltas = 0, idUser = 1, users =  [];

            numFaltas = validateSpaces(numFaltas);

            if(users !== null)
                idUser++;

            if(numFaltas === 0){
                clearPage();
                homePage();
            }
        }

        function validateNameAndNumb(numFaltas) {
                var thisInvalid = 0;
                var thisValid = 0;
                var identification; 
                var group = document.getElementById("groupNameNumb")
                users = JSON.parse(localStorage.getItem('users'));

                console.log(userNameNumb.validity.valid)

                if(!userNameNumb.validity.valid)
                    group.childNodes[5].innerHTML = "Por Favor insira o Nome de Utilizador ou Numero de Aluno"

                users.forEach(element => {
                    console.log(userNameNumb.value +" "+ element.Name)
                    if(userNameNumb.value !== element.Name && userNameNumb.value !== element.studentNumb){
                        group.childNodes[5].innerHTML = "Nome de Utilizador ou Numero de Aluno nÃ£o existe"
                        invalidate(userNameNumb);
                        invalidate(userPass);
                        numFaltas++;
                    }
                    else{
                        identification = element.idUser;
                        thisValid++;
                    }
                });

                if(thisValid !== 0){
                    group.childNodes[5].innerHTML = ""
                    validate(userNameNumb);
                    numFaltas = validatePass(numFaltas, identification);
                    thisInvalid = 0;
                }
                

                return numFaltas + thisInvalid;
            }

            function validatePass(numFaltas) {
                var thisInvalid = 0, thisValid = 0;
                var group = document.getElementById("groupPass")
                users = JSON.parse(localStorage.getItem('users'));

                console.log(userPass.validity.valid)

                if(!userPass.validity.valid)
                    group.childNodes[5].innerHTML = "Por Favor insira Password"

                
                    console.log(users[0].password)

                users.forEach(element => {
                    console.log(userPass.value + " " + element.Name)
                    if(userPass.value !== element.password){
                        group.childNodes[5].innerHTML = "Password Incorreta"
                        invalidate(userPass);
                        numFaltas++;
                    }
                    else{
                        thisValid++;
                    }
                });

                if(thisValid !== 0){
                    group.childNodes[5].innerHTML = ""
                    validate(userPass)
                    thisInvalid = 0;
                }

                return numFaltas + thisInvalid;
            }
        

        function invalidate(classNam) {
            classNam.classList.add("is-invalid");
            classNam.classList.remove("is-valid");
            classNam.classList.remove("was-validated");
        }

        function validate(classNam) {
            classNam.classList.add("is-valid");
            classNam.classList.remove("is-invalid")
            classNam.classList.add("was-validated");
        }


        function validateSpaces(numFaltas){
            numFaltas = validateNameAndNumb(numFaltas)

            numFaltas += rePassVal; 

            console.log(numFaltas)
            return numFaltas;
        }

        function clearPage(){

        for (let index = 0; index < validationSpaces.length; index++) {
                const element = validationSpaces[index];
                element.childNodes[3].value = ''
                element.classList.remove("was-validated");
        }
    }

    function homePage(){
        window.location.href = "http://127.0.0.1:5500/FrontEnd/dashboard/Home.html";
    }   
    function RegisterPage(){
                window.location.href = "http://127.0.0.1:5500/FrontEnd/RegisterPage/Register.html";
            }

    </script>
</html>
